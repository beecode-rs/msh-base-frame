import { singletonPattern } from '@beecode/msh-util/singleton/pattern';
import { promises as fs } from 'fs';
import os from 'os';
import path from 'path';
import { zEnumFetchTemplateStrategyType } from '#src/business/service/fetch-template/service';
import { z } from '#src/lib/zod-wrapper';
import { constant } from '#src/util/constant';
import { logger } from '#src/util/logger';
import { validationUtil } from '#src/util/validation-util';
export const userConfigurationTypeSchema = z
    .object({
    githubPersonAccessToken: z.string().optional(),
})
    .optional();
// eslint-disable-next-line @typescript-eslint/explicit-function-return-type
export const configurationTypeSchemaFactory = () => z.object({
    authorization: userConfigurationTypeSchema,
    localTemplateFolder: z.string().optional().default(path.resolve(process.cwd(), './.base-frame-tmp/')),
    template: z.object({
        fetchStrategy: zEnumFetchTemplateStrategyType,
        location: z.string(),
        variables: z.object({ projectName: z.string() }).loose(),
    }),
    tmpFolderPath: z.string(),
});
export class ConfigSetup {
    _configuration = undefined;
    get configuration() {
        return this._configuration;
    }
    async _getUserConfigIfExists() {
        try {
            const userConfigFileLocation = path.join(os.homedir(), '.base-frame.user.json');
            const userConfigContent = await fs.readFile(userConfigFileLocation, 'utf8');
            return validationUtil.parse(userConfigContent, userConfigurationTypeSchema);
        }
        catch (error) {
            if (error instanceof Error) {
                logger().warn('Error reading user config, continuing without it', error.message);
            }
            else {
                logger().warn('Unknown error reading user config, continuing without it', String(error));
            }
            return {};
        }
    }
    async initialize() {
        if (this._configuration !== undefined) {
            throw Error('Config already initialized');
        }
        const { configFilePath } = constant();
        // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition
        if (!(await fs.stat(configFilePath))) {
            throw Error(`Config file missing [${String(configFilePath)}]`);
        }
        const userJsonContent = await this._getUserConfigIfExists();
        const jsonContent = JSON.parse(await fs.readFile(configFilePath, 'utf8'));
        logger().debug('jsonContent', { jsonContent, userJsonContent });
        console.log('json content', { jsonContent, userJsonContent }); // eslint-disable-line no-console
        this._configuration = validationUtil.parse({
            ...jsonContent,
            authorisation: { ...userJsonContent, ...jsonContent.authorisation },
        }, configurationTypeSchemaFactory());
    }
}
export const configSetupSingleton = singletonPattern(() => {
    return new ConfigSetup();
});
export const config = () => {
    const conf = configSetupSingleton().configuration;
    if (!conf) {
        throw Error('Config not initialized');
    }
    return conf;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZmlnLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3V0aWwvY29uZmlnLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFDQUFxQyxDQUFBO0FBQ3RFLE9BQU8sRUFBRSxRQUFRLElBQUksRUFBRSxFQUFFLE1BQU0sSUFBSSxDQUFBO0FBQ25DLE9BQU8sRUFBRSxNQUFNLElBQUksQ0FBQTtBQUNuQixPQUFPLElBQUksTUFBTSxNQUFNLENBQUE7QUFFdkIsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0sOENBQThDLENBQUE7QUFDN0YsT0FBTyxFQUFFLENBQUMsRUFBRSxNQUFNLHNCQUFzQixDQUFBO0FBQ3hDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQTtBQUM3QyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFDekMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDJCQUEyQixDQUFBO0FBRTFELE1BQU0sQ0FBQyxNQUFNLDJCQUEyQixHQUFHLENBQUM7S0FDMUMsTUFBTSxDQUFDO0lBQ1AsdUJBQXVCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRTtDQUM5QyxDQUFDO0tBQ0QsUUFBUSxFQUFFLENBQUE7QUFJWiw0RUFBNEU7QUFDNUUsTUFBTSxDQUFDLE1BQU0sOEJBQThCLEdBQUcsR0FBRyxFQUFFLENBQ2xELENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDUixhQUFhLEVBQUUsMkJBQTJCO0lBQzFDLG1CQUFtQixFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEVBQUUsb0JBQW9CLENBQUMsQ0FBQztJQUNyRyxRQUFRLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUNsQixhQUFh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N0MsTUFBTSxJQUFJLEdBQUcsb0JBQW9CLEVBQUUsQ0FBQyxhQUFhLENBQUE7SUFDakQsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ1gsTUFBTSxLQUFLLENBQUMsd0JBQXdCLENBQUMsQ0FBQTtJQUN0QyxDQUFDO0lBRUQsT0FBTyxJQUFJLENBQUE7QUFDWixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzaW5nbGV0b25QYXR0ZXJuIH0gZnJvbSAnQGJlZWNvZGUvbXNoLXV0aWwvc2luZ2xldG9uL3BhdHRlcm4nXG5pbXBvcnQgeyBwcm9taXNlcyBhcyBmcyB9IGZyb20gJ2ZzJ1xuaW1wb3J0IG9zIGZyb20gJ29zJ1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcblxuaW1wb3J0IHsgekVudW1GZXRjaFRlbXBsYXRlU3RyYXRlZ3lUeXBlIH0gZnJvbSAnI3NyYy9idXNpbmVzcy9zZXJ2aWNlL2ZldGNoLXRlbXBsYXRlL3NlcnZpY2UnXG5pbXBvcnQgeyB6IH0gZnJvbSAnI3NyYy9saWIvem9kLXdyYXBwZXInXG5pbXBvcnQgeyBjb25zdGFudCB9IGZyb20gJyNzcmMvdXRpbC9jb25zdGFudCdcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJyNzcmMvdXRpbC9sb2dnZXInXG5pbXBvcnQgeyB2YWxpZGF0aW9uVXRpbCB9IGZyb20gJyNzcmMvdXRpbC92YWxpZGF0aW9uLXV0aWwnXG5cbmV4cG9ydCBjb25zdCB1c2VyQ29uZmlndXJhdGlvblR5cGVTY2hlbWEgPSB6XG5cdC5vYmplY3Qoe1xuXHRcdGdpdGh1YlBlcnNvbkFjY2Vzc1Rva2VuOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG5cdH0pXG5cdC5vcHRpb25hbCgpXG5cbmV4cG9ydCB0eXBlIFVzZXJDb25maWd1cmF0aW9uVHlwZSA9IHouaW5mZXI8dHlwZW9mIHVzZXJDb25maWd1cmF0aW9uVHlwZVNjaGVtYT5cblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9leHBsaWNpdC1mdW5jdGlvbi1yZXR1cm4tdHlwZVxuZXhwb3J0IGNvbnN0IGNvbmZpZ3VyYXRpb25UeXBlU2NoZW1hRmFjdG9yeSA9ICgpID0+XG5cdHoub2JqZWN0KHtcblx0XHRhdXRob3JpemF0aW9uOiB1c2VyQ29uZmlndXJhdGlvblR5cGVTY2hlbWEsXG5cdFx0bG9jYWxUZW1wbGF0ZUZvbGRlcjogei5zdHJpbmcoKS5vcHRpb25hbCgpLmRlZmF1bHQocGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksICcuLy5iYXNlLWZyYW1lLXRtcC8nKSksXG5cdFx0dGVtcGxhdGU6IHoub2JqZWN0KHtcblx0XHRcdGZldGNoU3RyYXRlZ3k6IHpFbnVtRmV0Y2hUZW1wbGF0ZVN0cmF0ZWd5VHlwZSxcblx0XHRcdGxvY2F0aW9uOiB6LnN0cmluZygpLFxuXHRcdFx0dmFyaWFibGVzOiB6Lm9iamVjdCh7IHByb2plY3ROYW1lOiB6LnN0cmluZygpIH0pLmxvb3NlKCksXG5cdFx0fSksXG5cdFx0dG1wRm9sZGVyUGF0aDogei5zdHJpbmcoKSxcblx0fSlcblxudHlwZSBDb25maWd1cmF0aW9uVHlwZSA9IHouaW5mZXI8UmV0dXJuVHlwZTx0eXBlb2YgY29uZmlndXJhdGlvblR5cGVTY2hlbWFGYWN0b3J5Pj5cblxuZXhwb3J0IGNsYXNzIENvbmZpZ1NldHVwIHtcblx0cHJvdGVjdGVkIF9jb25maWd1cmF0aW9uPzogQ29uZmlndXJhdGlvblR5cGUgPSB1bmRlZmluZWRcblxuXHRnZXQgY29uZmlndXJhdGlvbigpOiBDb25maWd1cmF0aW9uVHlwZSB8IHVuZGVmaW5lZCB7XG5cdFx0cmV0dXJuIHRoaXMuX2NvbmZpZ3VyYXRpb25cblx0fVxuXG5cdHByb3RlY3RlZCBhc3luYyBfZ2V0VXNlckNvbmZpZ0lmRXhpc3RzKCk6IFByb21pc2U8VXNlckNvbmZpZ3VyYXRpb25UeXBlPiB7XG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IHVzZXJDb25maWdGaWxlTG9jYXRpb24gPSBwYXRoLmpvaW4ob3MuaG9tZWRpcigpLCAnLmJhc2UtZnJhbWUudXNlci5qc29uJylcblx0XHRcdGNvbnN0IHVzZXJDb25maWdDb250ZW50ID0gYXdhaXQgZnMucmVhZEZpbGUodXNlckNvbmZpZ0ZpbGVMb2NhdGlvbiwgJ3V0ZjgnKVxuXG5cdFx0XHRyZXR1cm4gdmFsaWRhdGlvblV0aWwucGFyc2UodXNlckNvbmZpZ0NvbnRlbnQsIHVzZXJDb25maWd1cmF0aW9uVHlwZVNjaGVtYSlcblx0XHR9IGNhdGNoIChlcnJvcjogdW5rbm93bikge1xuXHRcdFx0aWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IpIHtcblx0XHRcdFx0bG9nZ2VyKCkud2FybignRXJyb3IgcmVhZGluZyB1c2VyIGNvbmZpZywgY29udGludWluZyB3aXRob3V0IGl0JywgZXJyb3IubWVzc2FnZSlcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGxvZ2dlcigpLndhcm4oJ1Vua25vd24gZXJyb3IgcmVhZGluZyB1c2VyIGNvbmZpZywgY29udGludWluZyB3aXRob3V0IGl0JywgU3RyaW5nKGVycm9yKSlcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIHt9XG5cdFx0fVxuXHR9XG5cblx0YXN5bmMgaW5pdGlhbGl6ZSgpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRpZiAodGhpcy5fY29uZmlndXJhdGlvbiAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHR0aHJvdyBFcnJvcignQ29uZmlnIGFscmVhZHkgaW5pdGlhbGl6ZWQnKVxuXHRcdH1cblx0XHRjb25zdCB7IGNvbmZpZ0ZpbGVQYXRoIH0gPSBjb25zdGFudCgpXG5cblx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVubmVjZXNzYXJ5LWNvbmRpdGlvblxuXHRcdGlmICghKGF3YWl0IGZzLnN0YXQoY29uZmlnRmlsZVBhdGgpKSkge1xuXHRcdFx0dGhyb3cgRXJyb3IoYENvbmZpZyBmaWxlIG1pc3NpbmcgWyR7U3RyaW5nKGNvbmZpZ0ZpbGVQYXRoKX1dYClcblx0XHR9XG5cblx0XHRjb25zdCB1c2VySnNvbkNvbnRlbnQgPSBhd2FpdCB0aGlzLl9nZXRVc2VyQ29uZmlnSWZFeGlzdHMoKVxuXHRcdGNvbnN0IGpzb25Db250ZW50ID0gSlNPTi5wYXJzZShhd2FpdCBmcy5yZWFkRmlsZShjb25maWdGaWxlUGF0aCwgJ3V0ZjgnKSlcblx0XHRsb2dnZXIoKS5kZWJ1ZygnanNvbkNvbnRlbnQnLCB7IGpzb25Db250ZW50LCB1c2VySnNvbkNvbnRlbnQgfSlcblx0XHRjb25zb2xlLmxvZygnanNvbiBjb250ZW50JywgeyBqc29uQ29udGVudCwgdXNlckpzb25Db250ZW50IH0pIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc29sZVxuXG5cdFx0dGhpcy5fY29uZmlndXJhdGlvbiA9IHZhbGlkYXRpb25VdGlsLnBhcnNlKFxuXHRcdFx0e1xuXHRcdFx0XHQuLi5qc29uQ29udGVudCxcblx0XHRcdFx0YXV0aG9yaXNhdGlvbjogeyAuLi51c2VySnNvbkNvbnRlbnQsIC4uLmpzb25Db250ZW50LmF1dGhvcmlzYXRpb24gfSxcblx0XHRcdH0sXG5cdFx0XHRjb25maWd1cmF0aW9uVHlwZVNjaGVtYUZhY3RvcnkoKVxuXHRcdClcblx0fVxufVxuXG5leHBvcnQgY29uc3QgY29uZmlnU2V0dXBTaW5nbGV0b24gPSBzaW5nbGV0b25QYXR0ZXJuKCgpID0+IHtcblx0cmV0dXJuIG5ldyBDb25maWdTZXR1cCgpXG59KVxuXG5leHBvcnQgY29uc3QgY29uZmlnID0gKCk6IENvbmZpZ3VyYXRpb25UeXBlID0+IHtcblx0Y29uc3QgY29uZiA9IGNvbmZpZ1NldHVwU2luZ2xldG9uKCkuY29uZmlndXJhdGlvblxuXHRpZiAoIWNvbmYpIHtcblx0XHR0aHJvdyBFcnJvcignQ29uZmlnIG5vdCBpbml0aWFsaXplZCcpXG5cdH1cblxuXHRyZXR1cm4gY29uZlxufVxuIl19