import { singletonPattern } from '@beecode/msh-util/singleton/pattern';
import { promises as fs } from 'fs';
import os from 'os';
import path from 'path';
import { FetchTemplateStrategyType } from '#src/business/model/fetch-template-strategy-type';
import { z } from '#src/lib/zod-adapter';
import { constant } from '#src/util/constant';
import { logger } from '#src/util/logger';
import { stringUtil } from '#src/util/string-util';
import { validationUtil } from '#src/util/validation-util';
export const userConfigurationTypeSchema = z
    .object({
    githubPersonAccessToken: z.string().optional(),
})
    .optional();
export const configurationTypeSchema = z.object({
    authorization: userConfigurationTypeSchema,
    template: z.object({
        fetchStrategy: z.enum(FetchTemplateStrategyType),
        forceOverride: z.boolean().optional().default(false),
        localDestinationFolder: z.string().optional().default(path.resolve(process.cwd(), './.base-frame-template/')),
        location: z.string(),
        subFolderLocation: z.string().optional(),
    }),
    tmpFolderPath: z.string().optional().default(stringUtil.generateRandomTmpFolderName()),
    variables: z.object({ projectName: z.string() }).loose(),
});
export class ConfigSetup {
    _configuration = undefined;
    get configuration() {
        return this._configuration;
    }
    async _getUserConfigIfExists() {
        try {
            const userConfigFileLocation = path.join(os.homedir(), '.base-frame.user.json');
            const userConfigContent = await fs.readFile(userConfigFileLocation, 'utf8');
            return validationUtil.parse(userConfigContent, userConfigurationTypeSchema);
        }
        catch (error) {
            const errorMessage = error.message ?? String(error);
            logger().info('Unknown error reading user config, continuing without it', errorMessage);
            return {};
        }
    }
    async initialize() {
        if (this._configuration !== undefined) {
            throw Error('Config already initialized');
        }
        const { configFilePath } = constant();
        // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition
        if (!(await fs.stat(configFilePath))) {
            throw Error(`Config file missing [${configFilePath}]`);
        }
        const userJsonContent = await this._getUserConfigIfExists();
        const jsonContent = JSON.parse(await fs.readFile(configFilePath, 'utf8'));
        logger().debug('jsonContent', { jsonContent, userJsonContent });
        this._configuration = validationUtil.parse({
            ...jsonContent,
            authorisation: { ...userJsonContent, ...jsonContent.authorisation },
        }, configurationTypeSchema);
    }
}
export const configSetupSingleton = singletonPattern(() => {
    return new ConfigSetup();
});
export const config = () => {
    const conf = configSetupSingleton().configuration;
    if (!conf) {
        throw Error('Config not initialized');
    }
    return conf;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZmlnLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3V0aWwvY29uZmlnLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFDQUFxQyxDQUFBO0FBQ3RFLE9BQU8sRUFBRSxRQUFRLElBQUksRUFBRSxFQUFFLE1BQU0sSUFBSSxDQUFBO0FBQ25DLE9BQU8sRUFBRSxNQUFNLElBQUksQ0FBQTtBQUNuQixPQUFPLElBQUksTUFBTSxNQUFNLENBQUE7QUFFdkIsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sa0RBQWtELENBQUE7QUFDNUYsT0FBTyxFQUFFLENBQUMsRUFBRSxNQUFNLHNCQUFzQixDQUFBO0FBQ3hDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQTtBQUM3QyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFDekMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHVCQUF1QixDQUFBO0FBQ2xELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQTtBQUUxRCxNQUFNLENBQUMsTUFBTSwyQkFBMkIsR0FBRyxDQUFDO0tBQzFDLE1BQU0sQ0FBQztJQUNQLHVCQUF1QixFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLEVBQUU7Q0FDOUMsQ0FBQztLQUNELFFBQVEsRUFBRSxDQUFBO0FBSVosTUFBTSxDQUFDLE1BQU0sdUJBQXVCLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUMvQyxhQUFhLEVBQUUsMkJBQTJCO0lBQzFDLFFBQVEsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ2xCLGFBQWEsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLHlCQUF5QixDQUFDO1FBQ2hELGFBQWEsRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQztR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QUFNLENBQUMsTUFBTSxNQUFNLEdBQUcsR0FBc0IsRUFBRTtJQUM3QyxNQUFNLElBQUksR0FBRyxvQkFBb0IsRUFBRSxDQUFDLGFBQWEsQ0FBQTtJQUNqRCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDWCxNQUFNLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxDQUFBO0lBQ3RDLENBQUM7SUFFRCxPQUFPLElBQUksQ0FBQTtBQUNaLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHNpbmdsZXRvblBhdHRlcm4gfSBmcm9tICdAYmVlY29kZS9tc2gtdXRpbC9zaW5nbGV0b24vcGF0dGVybidcbmltcG9ydCB7IHByb21pc2VzIGFzIGZzIH0gZnJvbSAnZnMnXG5pbXBvcnQgb3MgZnJvbSAnb3MnXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJ1xuXG5pbXBvcnQgeyBGZXRjaFRlbXBsYXRlU3RyYXRlZ3lUeXBlIH0gZnJvbSAnI3NyYy9idXNpbmVzcy9tb2RlbC9mZXRjaC10ZW1wbGF0ZS1zdHJhdGVneS10eXBlJ1xuaW1wb3J0IHsgeiB9IGZyb20gJyNzcmMvbGliL3pvZC1hZGFwdGVyJ1xuaW1wb3J0IHsgY29uc3RhbnQgfSBmcm9tICcjc3JjL3V0aWwvY29uc3RhbnQnXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcjc3JjL3V0aWwvbG9nZ2VyJ1xuaW1wb3J0IHsgc3RyaW5nVXRpbCB9IGZyb20gJyNzcmMvdXRpbC9zdHJpbmctdXRpbCdcbmltcG9ydCB7IHZhbGlkYXRpb25VdGlsIH0gZnJvbSAnI3NyYy91dGlsL3ZhbGlkYXRpb24tdXRpbCdcblxuZXhwb3J0IGNvbnN0IHVzZXJDb25maWd1cmF0aW9uVHlwZVNjaGVtYSA9IHpcblx0Lm9iamVjdCh7XG5cdFx0Z2l0aHViUGVyc29uQWNjZXNzVG9rZW46IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcblx0fSlcblx0Lm9wdGlvbmFsKClcblxuZXhwb3J0IHR5cGUgVXNlckNvbmZpZ3VyYXRpb25UeXBlID0gei5pbmZlcjx0eXBlb2YgdXNlckNvbmZpZ3VyYXRpb25UeXBlU2NoZW1hPlxuXG5leHBvcnQgY29uc3QgY29uZmlndXJhdGlvblR5cGVTY2hlbWEgPSB6Lm9iamVjdCh7XG5cdGF1dGhvcml6YXRpb246IHVzZXJDb25maWd1cmF0aW9uVHlwZVNjaGVtYSxcblx0dGVtcGxhdGU6IHoub2JqZWN0KHtcblx0XHRmZXRjaFN0cmF0ZWd5OiB6LmVudW0oRmV0Y2hUZW1wbGF0ZVN0cmF0ZWd5VHlwZSksXG5cdFx0Zm9yY2VPdmVycmlkZTogei5ib29sZWFuKCkub3B0aW9uYWwoKS5kZWZhdWx0KGZhbHNlKSxcblx0XHRsb2NhbERlc3RpbmF0aW9uRm9sZGVyOiB6LnN0cmluZygpLm9wdGlvbmFsKCkuZGVmYXVsdChwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgJy4vLmJhc2UtZnJhbWUtdGVtcGxhdGUvJykpLFxuXHRcdGxvY2F0aW9uOiB6LnN0cmluZygpLFxuXHRcdHN1YkZvbGRlckxvY2F0aW9uOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG5cdH0pLFxuXHR0bXBGb2xkZXJQYXRoOiB6LnN0cmluZygpLm9wdGlvbmFsKCkuZGVmYXVsdChzdHJpbmdVdGlsLmdlbmVyYXRlUmFuZG9tVG1wRm9sZGVyTmFtZSgpKSxcblx0dmFyaWFibGVzOiB6Lm9iamVjdCh7IHByb2plY3ROYW1lOiB6LnN0cmluZygpIH0pLmxvb3NlKCksXG59KVxuXG5leHBvcnQgdHlwZSBDb25maWd1cmF0aW9uVHlwZSA9IHouaW5mZXI8dHlwZW9mIGNvbmZpZ3VyYXRpb25UeXBlU2NoZW1hPlxuXG5leHBvcnQgY2xhc3MgQ29uZmlnU2V0dXAge1xuXHRwcm90ZWN0ZWQgX2NvbmZpZ3VyYXRpb24/OiBDb25maWd1cmF0aW9uVHlwZSA9IHVuZGVmaW5lZFxuXG5cdGdldCBjb25maWd1cmF0aW9uKCk6IENvbmZpZ3VyYXRpb25UeXBlIHwgdW5kZWZpbmVkIHtcblx0XHRyZXR1cm4gdGhpcy5fY29uZmlndXJhdGlvblxuXHR9XG5cblx0cHJvdGVjdGVkIGFzeW5jIF9nZXRVc2VyQ29uZmlnSWZFeGlzdHMoKTogUHJvbWlzZTxVc2VyQ29uZmlndXJhdGlvblR5cGU+IHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgdXNlckNvbmZpZ0ZpbGVMb2NhdGlvbiA9IHBhdGguam9pbihvcy5ob21lZGlyKCksICcuYmFzZS1mcmFtZS51c2VyLmpzb24nKVxuXHRcdFx0Y29uc3QgdXNlckNvbmZpZ0NvbnRlbnQgPSBhd2FpdCBmcy5yZWFkRmlsZSh1c2VyQ29uZmlnRmlsZUxvY2F0aW9uLCAndXRmOCcpXG5cblx0XHRcdHJldHVybiB2YWxpZGF0aW9uVXRpbC5wYXJzZSh1c2VyQ29uZmlnQ29udGVudCwgdXNlckNvbmZpZ3VyYXRpb25UeXBlU2NoZW1hKVxuXHRcdH0gY2F0Y2ggKGVycm9yOiB1bmtub3duKSB7XG5cdFx0XHRjb25zdCBlcnJvck1lc3NhZ2UgPSAoZXJyb3IgYXMgeyBtZXNzYWdlPzogc3RyaW5nIH0pLm1lc3NhZ2UgPz8gU3RyaW5nKGVycm9yKVxuXHRcdFx0bG9nZ2VyKCkuaW5mbygnVW5rbm93biBlcnJvciByZWFkaW5nIHVzZXIgY29uZmlnLCBjb250aW51aW5nIHdpdGhvdXQgaXQnLCBlcnJvck1lc3NhZ2UpXG5cblx0XHRcdHJldHVybiB7fVxuXHRcdH1cblx0fVxuXG5cdGFzeW5jIGluaXRpYWxpemUoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0aWYgKHRoaXMuX2NvbmZpZ3VyYXRpb24gIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0dGhyb3cgRXJyb3IoJ0NvbmZpZyBhbHJlYWR5IGluaXRpYWxpemVkJylcblx0XHR9XG5cdFx0Y29uc3QgeyBjb25maWdGaWxlUGF0aCB9ID0gY29uc3RhbnQoKVxuXG5cdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby11bm5lY2Vzc2FyeS1jb25kaXRpb25cblx0XHRpZiAoIShhd2FpdCBmcy5zdGF0KGNvbmZpZ0ZpbGVQYXRoKSkpIHtcblx0XHRcdHRocm93IEVycm9yKGBDb25maWcgZmlsZSBtaXNzaW5nIFske2NvbmZpZ0ZpbGVQYXRofV1gKVxuXHRcdH1cblxuXHRcdGNvbnN0IHVzZXJKc29uQ29udGVudCA9IGF3YWl0IHRoaXMuX2dldFVzZXJDb25maWdJZkV4aXN0cygpXG5cdFx0Y29uc3QganNvbkNvbnRlbnQgPSBKU09OLnBhcnNlKGF3YWl0IGZzLnJlYWRGaWxlKGNvbmZpZ0ZpbGVQYXRoLCAndXRmOCcpKVxuXHRcdGxvZ2dlcigpLmRlYnVnKCdqc29uQ29udGVudCcsIHsganNvbkNvbnRlbnQsIHVzZXJKc29uQ29udGVudCB9KVxuXG5cdFx0dGhpcy5fY29uZmlndXJhdGlvbiA9IHZhbGlkYXRpb25VdGlsLnBhcnNlKFxuXHRcdFx0e1xuXHRcdFx0XHQuLi5qc29uQ29udGVudCxcblx0XHRcdFx0YXV0aG9yaXNhdGlvbjogeyAuLi51c2VySnNvbkNvbnRlbnQsIC4uLmpzb25Db250ZW50LmF1dGhvcmlzYXRpb24gfSxcblx0XHRcdH0sXG5cdFx0XHRjb25maWd1cmF0aW9uVHlwZVNjaGVtYVxuXHRcdClcblx0fVxufVxuXG5leHBvcnQgY29uc3QgY29uZmlnU2V0dXBTaW5nbGV0b24gPSBzaW5nbGV0b25QYXR0ZXJuKCgpID0+IHtcblx0cmV0dXJuIG5ldyBDb25maWdTZXR1cCgpXG59KVxuXG5leHBvcnQgY29uc3QgY29uZmlnID0gKCk6IENvbmZpZ3VyYXRpb25UeXBlID0+IHtcblx0Y29uc3QgY29uZiA9IGNvbmZpZ1NldHVwU2luZ2xldG9uKCkuY29uZmlndXJhdGlvblxuXHRpZiAoIWNvbmYpIHtcblx0XHR0aHJvdyBFcnJvcignQ29uZmlnIG5vdCBpbml0aWFsaXplZCcpXG5cdH1cblxuXHRyZXR1cm4gY29uZlxufVxuIl19