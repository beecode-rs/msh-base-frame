import { singletonPattern } from '@beecode/msh-util/singleton/pattern';
import { promises as fs } from 'fs';
import os from 'os';
import path from 'path';
import { FetchTemplateStrategyType } from '#src/business/model/fetch-template-strategy-type';
import { z } from '#src/lib/zod-adapter';
import { constant } from '#src/util/constant';
import { logger } from '#src/util/logger';
import { stringUtil } from '#src/util/string-util';
import { validationUtil } from '#src/util/validation-util';
export const userConfigurationTypeSchema = z
    .object({
    githubPersonAccessToken: z.string().optional(),
})
    .optional();
export const configurationTypeSchema = z.object({
    authorization: userConfigurationTypeSchema,
    template: z.object({
        fetchStrategy: z.enum(FetchTemplateStrategyType),
        localDestinationFolder: z.string().optional().default(path.resolve(process.cwd(), './.base-frame-template/')),
        location: z.string(),
        subFolderLocation: z.string().optional(),
    }),
    tmpFolderPath: z.string().optional().default(stringUtil.generateRandomTmpFolderName()),
    variables: z.object({ projectName: z.string() }).loose(),
});
export class ConfigSetup {
    _configuration = undefined;
    get configuration() {
        return this._configuration;
    }
    async _getUserConfigIfExists() {
        try {
            const userConfigFileLocation = path.join(os.homedir(), '.base-frame.user.json');
            const userConfigContent = await fs.readFile(userConfigFileLocation, 'utf8');
            return validationUtil.parse(userConfigContent, userConfigurationTypeSchema);
        }
        catch (error) {
            if (error instanceof Error) {
                logger().warn('Error reading user config, continuing without it', error.message);
            }
            else {
                logger().warn('Unknown error reading user config, continuing without it', String(error));
            }
            return {};
        }
    }
    async initialize() {
        if (this._configuration !== undefined) {
            throw Error('Config already initialized');
        }
        const { configFilePath } = constant();
        // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition
        if (!(await fs.stat(configFilePath))) {
            throw Error(`Config file missing [${configFilePath}]`);
        }
        const userJsonContent = await this._getUserConfigIfExists();
        const jsonContent = JSON.parse(await fs.readFile(configFilePath, 'utf8'));
        logger().debug('jsonContent', { jsonContent, userJsonContent });
        this._configuration = validationUtil.parse({
            ...jsonContent,
            authorisation: { ...userJsonContent, ...jsonContent.authorisation },
        }, configurationTypeSchema);
    }
}
export const configSetupSingleton = singletonPattern(() => {
    return new ConfigSetup();
});
export const config = () => {
    const conf = configSetupSingleton().configuration;
    if (!conf) {
        throw Error('Config not initialized');
    }
    return conf;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZmlnLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3V0aWwvY29uZmlnLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFDQUFxQyxDQUFBO0FBQ3RFLE9BQU8sRUFBRSxRQUFRLElBQUksRUFBRSxFQUFFLE1BQU0sSUFBSSxDQUFBO0FBQ25DLE9BQU8sRUFBRSxNQUFNLElBQUksQ0FBQTtBQUNuQixPQUFPLElBQUksTUFBTSxNQUFNLENBQUE7QUFFdkIsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sa0RBQWtELENBQUE7QUFDNUYsT0FBTyxFQUFFLENBQUMsRUFBRSxNQUFNLHNCQUFzQixDQUFBO0FBQ3hDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQTtBQUM3QyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFDekMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHVCQUF1QixDQUFBO0FBQ2xELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQTtBQUUxRCxNQUFNLENBQUMsTUFBTSwyQkFBMkIsR0FBRyxDQUFDO0tBQzFDLE1BQU0sQ0FBQztJQUNQLHVCQUF1QixFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLEVBQUU7Q0FDOUMsQ0FBQztLQUNELFFBQVEsRUFBRSxDQUFBO0FBSVosTUFBTSxDQUFDLE1BQU0sdUJBQXVCLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUMvQyxhQUFhLEVBQUUsMkJBQTJCO0lBQzFDLFFBQVEsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ2xCLGFBQWEsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLHlCQUF5QixDQUFDO1FBQ2hELHNCQUFzQixFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFD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QUE7QUFFRixNQUFNLENBQUMsTUFBTSxNQUFNLEdBQUcsR0FBc0IsRUFBRTtJQUM3QyxNQUFNLElBQUksR0FBRyxvQkFBb0IsRUFBRSxDQUFDLGFBQWEsQ0FBQTtJQUNqRCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDWCxNQUFNLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxDQUFBO0lBQ3RDLENBQUM7SUFFRCxPQUFPLElBQUksQ0FBQTtBQUNaLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHNpbmdsZXRvblBhdHRlcm4gfSBmcm9tICdAYmVlY29kZS9tc2gtdXRpbC9zaW5nbGV0b24vcGF0dGVybidcbmltcG9ydCB7IHByb21pc2VzIGFzIGZzIH0gZnJvbSAnZnMnXG5pbXBvcnQgb3MgZnJvbSAnb3MnXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJ1xuXG5pbXBvcnQgeyBGZXRjaFRlbXBsYXRlU3RyYXRlZ3lUeXBlIH0gZnJvbSAnI3NyYy9idXNpbmVzcy9tb2RlbC9mZXRjaC10ZW1wbGF0ZS1zdHJhdGVneS10eXBlJ1xuaW1wb3J0IHsgeiB9IGZyb20gJyNzcmMvbGliL3pvZC1hZGFwdGVyJ1xuaW1wb3J0IHsgY29uc3RhbnQgfSBmcm9tICcjc3JjL3V0aWwvY29uc3RhbnQnXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcjc3JjL3V0aWwvbG9nZ2VyJ1xuaW1wb3J0IHsgc3RyaW5nVXRpbCB9IGZyb20gJyNzcmMvdXRpbC9zdHJpbmctdXRpbCdcbmltcG9ydCB7IHZhbGlkYXRpb25VdGlsIH0gZnJvbSAnI3NyYy91dGlsL3ZhbGlkYXRpb24tdXRpbCdcblxuZXhwb3J0IGNvbnN0IHVzZXJDb25maWd1cmF0aW9uVHlwZVNjaGVtYSA9IHpcblx0Lm9iamVjdCh7XG5cdFx0Z2l0aHViUGVyc29uQWNjZXNzVG9rZW46IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcblx0fSlcblx0Lm9wdGlvbmFsKClcblxuZXhwb3J0IHR5cGUgVXNlckNvbmZpZ3VyYXRpb25UeXBlID0gei5pbmZlcjx0eXBlb2YgdXNlckNvbmZpZ3VyYXRpb25UeXBlU2NoZW1hPlxuXG5leHBvcnQgY29uc3QgY29uZmlndXJhdGlvblR5cGVTY2hlbWEgPSB6Lm9iamVjdCh7XG5cdGF1dGhvcml6YXRpb246IHVzZXJDb25maWd1cmF0aW9uVHlwZVNjaGVtYSxcblx0dGVtcGxhdGU6IHoub2JqZWN0KHtcblx0XHRmZXRjaFN0cmF0ZWd5OiB6LmVudW0oRmV0Y2hUZW1wbGF0ZVN0cmF0ZWd5VHlwZSksXG5cdFx0bG9jYWxEZXN0aW5hdGlvbkZvbGRlcjogei5zdHJpbmcoKS5vcHRpb25hbCgpLmRlZmF1bHQocGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksICcuLy5iYXNlLWZyYW1lLXRlbXBsYXRlLycpKSxcblx0XHRsb2NhdGlvbjogei5zdHJpbmcoKSxcblx0XHRzdWJGb2xkZXJMb2NhdGlvbjogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuXHR9KSxcblx0dG1wRm9sZGVyUGF0aDogei5zdHJpbmcoKS5vcHRpb25hbCgpLmRlZmF1bHQoc3RyaW5nVXRpbC5nZW5lcmF0ZVJhbmRvbVRtcEZvbGRlck5hbWUoKSksXG5cdHZhcmlhYmxlczogei5vYmplY3QoeyBwcm9qZWN0TmFtZTogei5zdHJpbmcoKSB9KS5sb29zZSgpLFxufSlcblxuZXhwb3J0IHR5cGUgQ29uZmlndXJhdGlvblR5cGUgPSB6LmluZmVyPHR5cGVvZiBjb25maWd1cmF0aW9uVHlwZVNjaGVtYT5cblxuZXhwb3J0IGNsYXNzIENvbmZpZ1NldHVwIHtcblx0cHJvdGVjdGVkIF9jb25maWd1cmF0aW9uPzogQ29uZmlndXJhdGlvblR5cGUgPSB1bmRlZmluZWRcblxuXHRnZXQgY29uZmlndXJhdGlvbigpOiBDb25maWd1cmF0aW9uVHlwZSB8IHVuZGVmaW5lZCB7XG5cdFx0cmV0dXJuIHRoaXMuX2NvbmZpZ3VyYXRpb25cblx0fVxuXG5cdHByb3RlY3RlZCBhc3luYyBfZ2V0VXNlckNvbmZpZ0lmRXhpc3RzKCk6IFByb21pc2U8VXNlckNvbmZpZ3VyYXRpb25UeXBlPiB7XG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IHVzZXJDb25maWdGaWxlTG9jYXRpb24gPSBwYXRoLmpvaW4ob3MuaG9tZWRpcigpLCAnLmJhc2UtZnJhbWUudXNlci5qc29uJylcblx0XHRcdGNvbnN0IHVzZXJDb25maWdDb250ZW50ID0gYXdhaXQgZnMucmVhZEZpbGUodXNlckNvbmZpZ0ZpbGVMb2NhdGlvbiwgJ3V0ZjgnKVxuXG5cdFx0XHRyZXR1cm4gdmFsaWRhdGlvblV0aWwucGFyc2UodXNlckNvbmZpZ0NvbnRlbnQsIHVzZXJDb25maWd1cmF0aW9uVHlwZVNjaGVtYSlcblx0XHR9IGNhdGNoIChlcnJvcjogdW5rbm93bikge1xuXHRcdFx0aWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IpIHtcblx0XHRcdFx0bG9nZ2VyKCkud2FybignRXJyb3IgcmVhZGluZyB1c2VyIGNvbmZpZywgY29udGludWluZyB3aXRob3V0IGl0JywgZXJyb3IubWVzc2FnZSlcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGxvZ2dlcigpLndhcm4oJ1Vua25vd24gZXJyb3IgcmVhZGluZyB1c2VyIGNvbmZpZywgY29udGludWluZyB3aXRob3V0IGl0JywgU3RyaW5nKGVycm9yKSlcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIHt9XG5cdFx0fVxuXHR9XG5cblx0YXN5bmMgaW5pdGlhbGl6ZSgpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRpZiAodGhpcy5fY29uZmlndXJhdGlvbiAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHR0aHJvdyBFcnJvcignQ29uZmlnIGFscmVhZHkgaW5pdGlhbGl6ZWQnKVxuXHRcdH1cblx0XHRjb25zdCB7IGNvbmZpZ0ZpbGVQYXRoIH0gPSBjb25zdGFudCgpXG5cblx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVubmVjZXNzYXJ5LWNvbmRpdGlvblxuXHRcdGlmICghKGF3YWl0IGZzLnN0YXQoY29uZmlnRmlsZVBhdGgpKSkge1xuXHRcdFx0dGhyb3cgRXJyb3IoYENvbmZpZyBmaWxlIG1pc3NpbmcgWyR7Y29uZmlnRmlsZVBhdGh9XWApXG5cdFx0fVxuXG5cdFx0Y29uc3QgdXNlckpzb25Db250ZW50ID0gYXdhaXQgdGhpcy5fZ2V0VXNlckNvbmZpZ0lmRXhpc3RzKClcblx0XHRjb25zdCBqc29uQ29udGVudCA9IEpTT04ucGFyc2UoYXdhaXQgZnMucmVhZEZpbGUoY29uZmlnRmlsZVBhdGgsICd1dGY4JykpXG5cdFx0bG9nZ2VyKCkuZGVidWcoJ2pzb25Db250ZW50JywgeyBqc29uQ29udGVudCwgdXNlckpzb25Db250ZW50IH0pXG5cblx0XHR0aGlzLl9jb25maWd1cmF0aW9uID0gdmFsaWRhdGlvblV0aWwucGFyc2UoXG5cdFx0XHR7XG5cdFx0XHRcdC4uLmpzb25Db250ZW50LFxuXHRcdFx0XHRhdXRob3Jpc2F0aW9uOiB7IC4uLnVzZXJKc29uQ29udGVudCwgLi4uanNvbkNvbnRlbnQuYXV0aG9yaXNhdGlvbiB9LFxuXHRcdFx0fSxcblx0XHRcdGNvbmZpZ3VyYXRpb25UeXBlU2NoZW1hXG5cdFx0KVxuXHR9XG59XG5cbmV4cG9ydCBjb25zdCBjb25maWdTZXR1cFNpbmdsZXRvbiA9IHNpbmdsZXRvblBhdHRlcm4oKCkgPT4ge1xuXHRyZXR1cm4gbmV3IENvbmZpZ1NldHVwKClcbn0pXG5cbmV4cG9ydCBjb25zdCBjb25maWcgPSAoKTogQ29uZmlndXJhdGlvblR5cGUgPT4ge1xuXHRjb25zdCBjb25mID0gY29uZmlnU2V0dXBTaW5nbGV0b24oKS5jb25maWd1cmF0aW9uXG5cdGlmICghY29uZikge1xuXHRcdHRocm93IEVycm9yKCdDb25maWcgbm90IGluaXRpYWxpemVkJylcblx0fVxuXG5cdHJldHVybiBjb25mXG59XG4iXX0=