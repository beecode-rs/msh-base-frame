import { arrayUtil } from '@beecode/msh-util/array-util';
import { promises as fs } from 'fs';
import { copy } from 'fs-extra';
import { glob } from 'glob';
import { logger } from '#src/util/logger';
export class FileAdapter {
    async copy(params) {
        const { sourceFilePath, destinationFilePath, options = { ignore: [] } } = params;
        const copyContentList = await glob('**/*', {
            cwd: sourceFilePath,
            dot: true,
            ignore: [...options.ignore, '.bfignore'],
            nodir: true,
        });
        await Promise.all(copyContentList.map((file) => {
            return copy(`${sourceFilePath}/${file}`, `${destinationFilePath}/${file}`);
        }));
    }
    async copyFilesIfNotExists(params) {
        const { sourceFilePath, destinationFilePath } = params;
        await copy(sourceFilePath, destinationFilePath, { overwrite: false });
    }
    async filterFiles(params) {
        const { fileFolderPathList } = params;
        const filtered = await Promise.all(fileFolderPathList.map(async (fileFolderPath) => {
            if (await this.isFile({ filePath: fileFolderPath })) {
                return fileFolderPath;
            }
            return undefined;
        }));
        return filtered.filter(arrayUtil.notEmpty);
    }
    async getFolderContent(params) {
        const { folderPath } = params;
        return fs.readdir(folderPath);
    }
    async getRecurringFolderContent(params) {
        const { folderPath } = params;
        if (!(await this.isDirectory({ folderPath }))) {
            return [];
        }
        const folderContent = (await this.getFolderContent({ folderPath })).map((folderContentPath) => {
            return `${folderPath}/${folderContentPath}`;
        });
        const subFolderContents = await Promise.all(folderContent.map((folderContentPath) => {
            return this.getRecurringFolderContent({ folderPath: folderContentPath });
        }));
        return [...folderContent, ...subFolderContents.flat()];
    }
    async isDirectory(params) {
        const { folderPath } = params;
        try {
            const stat = await fs.stat(folderPath);
            return stat.isDirectory();
        }
        catch (error) {
            logger().error('FileClient.isDirectory', { error });
            return false;
        }
    }
    async isFile(params) {
        const { filePath } = params;
        try {
            const stat = await fs.stat(filePath);
            return stat.isFile();
        }
        catch (error) {
            logger().error('FileClient.isFile', { error });
            return false;
        }
    }
    async makeFolderIfNotExist(params) {
        const { folderPath } = params;
        if (await fs.stat(folderPath).catch(() => false)) {
            return;
        }
        return fs.mkdir(folderPath);
    }
    async readFile(params) {
        const { filePath } = params;
        return fs.readFile(filePath, { encoding: 'utf-8' });
    }
    async removeFile(params) {
        const { filePath } = params;
        if (!(await fs.stat(filePath).catch(() => false))) {
            return;
        }
        return fs.rm(filePath);
    }
    async removeFolder(params) {
        const { folderPath } = params;
        if (!(await fs.stat(folderPath).catch(() => false))) {
            return;
        }
        return fs.rm(folderPath, { force: true, recursive: true });
    }
    writeToFile(params) {
        const { filePath, fileContent } = params;
        return fs.writeFile(filePath, fileContent, 'utf-8');
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS1hZGFwdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2xpYi9maWxlLWFkYXB0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDhCQUE4QixDQUFBO0FBQ3hELE9BQU8sRUFBRSxRQUFRLElBQUksRUFBRSxFQUFFLE1BQU0sSUFBSSxDQUFBO0FBQ25DLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxVQUFVLENBQUE7QUFDL0IsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLE1BQU0sQ0FBQTtBQUUzQixPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFFekMsTUFBTSxPQUFPLFdBQVc7SUFDdkIsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUErRjtRQUN6RyxNQUFNLEVBQUUsY0FBYyxFQUFFLG1CQUFtQixFQUFFLE9BQU8sR0FBRyxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsRUFBRSxHQUFHLE1BQU0sQ0FBQTtRQUVoRixNQUFNLGVBQWUsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDMUMsR0FBRyxFQUFFLGNBQWM7WUFDbkIsR0FBRyxFQUFFLElBQUk7WUFDVCxNQUFNLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUUsV0FBVyxDQUFDO1lBQ3hDLEtBQUssRUFBRSxJQUFJO1NBQ1gsQ0FBQyxDQUFBO1FBRUYsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUNoQixlQUFlLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBWSxFQUFFLEVBQUU7WUFDcEMsT0FBTyxJQUFJLENBQUMsR0FBRyxjQUFjLElBQUksSUFBSSxFQUFFLEVBQUUsR0FBRyxtQkFBbUIsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFBO1FBQzNFLENBQUMsQ0FBQyxDQUNGLENBQUE7SUFDRixDQUFDO0lBRUQsS0FBSyxDQUFDLG9CQUFvQixDQUFDLE1BQStEO1FBQ3pGLE1B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QUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQztZQUNyRCxPQUFNO1FBQ1AsQ0FBQztRQUVELE9BQU8sRUFBRSxDQUFDLEVBQUUsQ0FBQyxVQUFVLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFBO0lBQzNELENBQUM7SUFFRCxXQUFXLENBQUMsTUFBaUQ7UUFDNUQsTUFBTSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsR0FBRyxNQUFNLENBQUE7UUFFeEMsT0FBTyxFQUFFLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxXQUFXLEVBQUUsT0FBTyxDQUFDLENBQUE7SUFDcEQsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYXJyYXlVdGlsIH0gZnJvbSAnQGJlZWNvZGUvbXNoLXV0aWwvYXJyYXktdXRpbCdcbmltcG9ydCB7IHByb21pc2VzIGFzIGZzIH0gZnJvbSAnZnMnXG5pbXBvcnQgeyBjb3B5IH0gZnJvbSAnZnMtZXh0cmEnXG5pbXBvcnQgeyBnbG9iIH0gZnJvbSAnZ2xvYidcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnI3NyYy91dGlsL2xvZ2dlcidcblxuZXhwb3J0IGNsYXNzIEZpbGVBZGFwdGVyIHtcblx0YXN5bmMgY29weShwYXJhbXM6IHsgc291cmNlRmlsZVBhdGg6IHN0cmluZzsgZGVzdGluYXRpb25GaWxlUGF0aDogc3RyaW5nOyBvcHRpb25zPzogeyBpZ25vcmU6IHN0cmluZ1tdIH0gfSk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGNvbnN0IHsgc291cmNlRmlsZVBhdGgsIGRlc3RpbmF0aW9uRmlsZVBhdGgsIG9wdGlvbnMgPSB7IGlnbm9yZTogW10gfSB9ID0gcGFyYW1zXG5cblx0XHRjb25zdCBjb3B5Q29udGVudExpc3QgPSBhd2FpdCBnbG9iKCcqKi8qJywge1xuXHRcdFx0Y3dkOiBzb3VyY2VGaWxlUGF0aCxcblx0XHRcdGRvdDogdHJ1ZSxcblx0XHRcdGlnbm9yZTogWy4uLm9wdGlvbnMuaWdub3JlLCAnLmJmaWdub3JlJ10sXG5cdFx0XHRub2RpcjogdHJ1ZSxcblx0XHR9KVxuXG5cdFx0YXdhaXQgUHJvbWlzZS5hbGwoXG5cdFx0XHRjb3B5Q29udGVudExpc3QubWFwKChmaWxlOiBzdHJpbmcpID0+IHtcblx0XHRcdFx0cmV0dXJuIGNvcHkoYCR7c291cmNlRmlsZVBhdGh9LyR7ZmlsZX1gLCBgJHtkZXN0aW5hdGlvbkZpbGVQYXRofS8ke2ZpbGV9YClcblx0XHRcdH0pXG5cdFx0KVxuXHR9XG5cblx0YXN5bmMgY29weUZpbGVzSWZOb3RFeGlzdHMocGFyYW1zOiB7IHNvdXJjZUZpbGVQYXRoOiBzdHJpbmc7IGRlc3RpbmF0aW9uRmlsZVBhdGg6IHN0cmluZyB9KTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3QgeyBzb3VyY2VGaWxlUGF0aCwgZGVzdGluYXRpb25GaWxlUGF0aCB9ID0gcGFyYW1zXG5cblx0XHRhd2FpdCBjb3B5KHNvdXJjZUZpbGVQYXRoLCBkZXN0aW5hdGlvbkZpbGVQYXRoLCB7IG92ZXJ3cml0ZTogZmFsc2UgfSlcblx0fVxuXG5cdGFzeW5jIGZpbHRlckZpbGVzKHBhcmFtczogeyBmaWxlRm9sZGVyUGF0aExpc3Q6IHN0cmluZ1tdIH0pOiBQcm9taXNlPHN0cmluZ1tdPiB7XG5cdFx0Y29uc3QgeyBmaWxlRm9sZGVyUGF0aExpc3QgfSA9IHBhcmFtc1xuXG5cdFx0Y29uc3QgZmlsdGVyZWQgPSBhd2FpdCBQcm9taXNlLmFsbChcblx0XHRcdGZpbGVGb2xkZXJQYXRoTGlzdC5tYXAoYXN5bmMgKGZpbGVGb2xkZXJQYXRoKSA9PiB7XG5cdFx0XHRcdGlmIChhd2FpdCB0aGlzLmlzRmlsZSh7IGZpbGVQYXRoOiBmaWxlRm9sZGVyUGF0aCB9KSkge1xuXHRcdFx0XHRcdHJldHVybiBmaWxlRm9sZGVyUGF0aFxuXHRcdFx0XHR9XG5cblx0XHRcdFx0cmV0dXJuIHVuZGVmaW5lZFxuXHRcdFx0fSlcblx0XHQpXG5cblx0XHRyZXR1cm4gZmlsdGVyZWQuZmlsdGVyKGFycmF5VXRpbC5ub3RFbXB0eSlcblx0fVxuXG5cdGFzeW5jIGdldEZvbGRlckNvbnRlbnQocGFyYW1zOiB7IGZvbGRlclBhdGg6IHN0cmluZyB9KTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuXHRcdGNvbnN0IHsgZm9sZGVyUGF0aCB9ID0gcGFyYW1zXG5cblx0XHRyZXR1cm4gZnMucmVhZGRpcihmb2xkZXJQYXRoKVxuXHR9XG5cblx0YXN5bmMgZ2V0UmVjdXJyaW5nRm9sZGVyQ29udGVudChwYXJhbXM6IHsgZm9sZGVyUGF0aDogc3RyaW5nIH0pOiBQcm9taXNlPHN0cmluZ1tdPiB7XG5cdFx0Y29uc3QgeyBmb2xkZXJQYXRoIH0gPSBwYXJhbXNcblxuXHRcdGlmICghKGF3YWl0IHRoaXMuaXNEaXJlY3RvcnkoeyBmb2xkZXJQYXRoIH0pKSkge1xuXHRcdFx0cmV0dXJuIFtdXG5cdFx0fVxuXHRcdGNvbnN0IGZvbGRlckNvbnRlbnQgPSAoYXdhaXQgdGhpcy5nZXRGb2xkZXJDb250ZW50KHsgZm9sZGVyUGF0aCB9KSkubWFwKChmb2xkZXJDb250ZW50UGF0aCkgPT4ge1xuXHRcdFx0cmV0dXJuIGAke2ZvbGRlclBhdGh9LyR7Zm9sZGVyQ29udGVudFBhdGh9YFxuXHRcdH0pXG5cdFx0Y29uc3Qgc3ViRm9sZGVyQ29udGVudHMgPSBhd2FpdCBQcm9taXNlLmFsbChcblx0XHRcdGZvbGRlckNvbnRlbnQubWFwKChmb2xkZXJDb250ZW50UGF0aCkgPT4ge1xuXHRcdFx0XHRyZXR1cm4gdGhpcy5nZXRSZWN1cnJpbmdGb2xkZXJDb250ZW50KHsgZm9sZGVyUGF0aDogZm9sZGVyQ29udGVudFBhdGggfSlcblx0XHRcdH0pXG5cdFx0KVxuXG5cdFx0cmV0dXJuIFsuLi5mb2xkZXJDb250ZW50LCAuLi5zdWJGb2xkZXJDb250ZW50cy5mbGF0KCldXG5cdH1cblxuXHRhc3luYyBpc0RpcmVjdG9yeShwYXJhbXM6IHsgZm9sZGVyUGF0aDogc3RyaW5nIH0pOiBQcm9taXNlPGJvb2xlYW4+IHtcblx0XHRjb25zdCB7IGZvbGRlclBhdGggfSA9IHBhcmFtc1xuXG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IHN0YXQgPSBhd2FpdCBmcy5zdGF0KGZvbGRlclBhdGgpXG5cblx0XHRcdHJldHVybiBzdGF0LmlzRGlyZWN0b3J5KClcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0bG9nZ2VyKCkuZXJyb3IoJ0ZpbGVDbGllbnQuaXNEaXJlY3RvcnknLCB7IGVycm9yIH0pXG5cblx0XHRcdHJldHVybiBmYWxzZVxuXHRcdH1cblx0fVxuXG5cdGFzeW5jIGlzRmlsZShwYXJhbXM6IHsgZmlsZVBhdGg6IHN0cmluZyB9KTogUHJvbWlzZTxib29sZWFuPiB7XG5cdFx0Y29uc3QgeyBmaWxlUGF0aCB9ID0gcGFyYW1zXG5cblx0XHR0cnkge1xuXHRcdFx0Y29uc3Qgc3RhdCA9IGF3YWl0IGZzLnN0YXQoZmlsZVBhdGgpXG5cblx0XHRcdHJldHVybiBzdGF0LmlzRmlsZSgpXG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdGxvZ2dlcigpLmVycm9yKCdGaWxlQ2xpZW50LmlzRmlsZScsIHsgZXJyb3IgfSlcblxuXHRcdFx0cmV0dXJuIGZhbHNlXG5cdFx0fVxuXHR9XG5cblx0YXN5bmMgbWFrZUZvbGRlcklmTm90RXhpc3QocGFyYW1zOiB7IGZvbGRlclBhdGg6IHN0cmluZyB9KTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3QgeyBmb2xkZXJQYXRoIH0gPSBwYXJhbXNcblxuXHRcdGlmIChhd2FpdCBmcy5zdGF0KGZvbGRlclBhdGgpLmNhdGNoKCgpID0+IGZhbHNlKSkge1xuXHRcdFx0cmV0dXJuXG5cdFx0fVxuXG5cdFx0cmV0dXJuIGZzLm1rZGlyKGZvbGRlclBhdGgpXG5cdH1cblxuXHRhc3luYyByZWFkRmlsZShwYXJhbXM6IHsgZmlsZVBhdGg6IHN0cmluZyB9KTogUHJvbWlzZTxzdHJpbmc+IHtcblx0XHRjb25zdCB7IGZpbGVQYXRoIH0gPSBwYXJhbXNcblxuXHRcdHJldHVybiBmcy5yZWFkRmlsZShmaWxlUGF0aCwgeyBlbmNvZGluZzogJ3V0Zi04JyB9KVxuXHR9XG5cblx0YXN5bmMgcmVtb3ZlRmlsZShwYXJhbXM6IHsgZmlsZVBhdGg6IHN0cmluZyB9KTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3QgeyBmaWxlUGF0aCB9ID0gcGFyYW1zXG5cblx0XHRpZiAoIShhd2FpdCBmcy5zdGF0KGZpbGVQYXRoKS5jYXRjaCgoKSA9PiBmYWxzZSkpKSB7XG5cdFx0XHRyZXR1cm5cblx0XHR9XG5cblx0XHRyZXR1cm4gZnMucm0oZmlsZVBhdGgpXG5cdH1cblxuXHRhc3luYyByZW1vdmVGb2xkZXIocGFyYW1zOiB7IGZvbGRlclBhdGg6IHN0cmluZyB9KTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3QgeyBmb2xkZXJQYXRoIH0gPSBwYXJhbXNcblxuXHRcdGlmICghKGF3YWl0IGZzLnN0YXQoZm9sZGVyUGF0aCkuY2F0Y2goKCkgPT4gZmFsc2UpKSkge1xuXHRcdFx0cmV0dXJuXG5cdFx0fVxuXG5cdFx0cmV0dXJuIGZzLnJtKGZvbGRlclBhdGgsIHsgZm9yY2U6IHRydWUsIHJlY3Vyc2l2ZTogdHJ1ZSB9KVxuXHR9XG5cblx0d3JpdGVUb0ZpbGUocGFyYW1zOiB7IGZpbGVQYXRoOiBzdHJpbmc7IGZpbGVDb250ZW50OiBzdHJpbmcgfSk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGNvbnN0IHsgZmlsZVBhdGgsIGZpbGVDb250ZW50IH0gPSBwYXJhbXNcblxuXHRcdHJldHVybiBmcy53cml0ZUZpbGUoZmlsZVBhdGgsIGZpbGVDb250ZW50LCAndXRmLTgnKVxuXHR9XG59XG4iXX0=